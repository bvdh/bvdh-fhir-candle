@using FhirCandle.Authorization.Services
@using FhirCandle.Authorization.Models
@using Microsoft.FluentUI.AspNetCore.Components;

@page "/smart/approveStudies"

@inject NavigationManager NavigationManager
@inject IFhirStoreManager StoreManager
@inject ISmartAuthorizationManager AuthorizationManager

@implements IDisposable

<PageTitle>SMART Approve Studies</PageTitle>

<FluentStack Orientation="Orientation.Vertical" VerticalGap="8">

@if (string.IsNullOrEmpty(ErrorMessage))
{
    <FluentLabel Typo="Typography.H4">SMART Approve Studies</FluentLabel>
    <FluentLabel Typo="Typography.Body">Please select allowed studies:</FluentLabel>

    <FluentStack Orientation="Orientation.Horizontal" Spacing="4">
        <FluentButton BackgroundColor="var(--success)" OnClick="@(() => ApproveAuth())">Approve Selected Studies</FluentButton>
        <FluentButton BackgroundColor="var(--error)" OnClick="@(() => DenyAuth())">Cancel</FluentButton>
    </FluentStack>

    <FluentCheckbox Label="@($"All Studies")"
                ThreeState="true"
                ShowIndeterminate="false"
                @bind-CheckState="AllImagingStudieselected" />

    <FluentDataGrid Items="@_items" GridTemplateColumns="1fr 2fr" RowClass="@(s => _selected.Contains(s.StudyId) ? "highlighted-row" : null!)" OnRowFocus="HandleRowFocus" TGridItem=ImagingStudyInfo>
        <PropertyColumn Title="Study" Property="@(t => t.StudyId)" Sortable="true" Tooltip="true">
        </PropertyColumn>

        <PropertyColumn Title="Description" Property="@(t => t.StudyDescription)" Sortable="true" Tooltip="true">
        </PropertyColumn>
    </FluentDataGrid>
}
else
{
    <FluentLabel Typo="Typography.H4">SMART Approve Studies</FluentLabel>
    <FluentLabel Typo="Typography.Body">Error</FluentLabel>
    <FluentLabel Typo="Typography.Body">@ErrorMessage</FluentLabel>
}

</FluentStack>


@code {
    /// <summary>Gets or sets the navigation tracker.</summary>
    [CascadingParameter]
    public INavTracker? NavTracker { get; set; } = null;

    private NavPageInfoRec[] _navPages => new NavPageInfoRec[]
    {
        new() { Display = "Authorization: " + StoreName, Link = $"/smart/approveStudies?store={StoreName}&key={Key}" },
    };

    private record class ImagingStudyInfo
    {
        public required string StudyId { get; init; }
        public string StudyDescription { get; init; } = string.Empty;
    }

    private IQueryable<ImagingStudyInfo> _items = Array.Empty<ImagingStudyInfo>().AsQueryable();

    /// <summary>The selected scopes.</summary>
    private readonly HashSet<string> _selected = new();

    /// <summary>Gets or sets all scopes selected.</summary>
    private bool? AllImagingStudieselected
    {
        get =>
            _selected.SetEquals(_auth.Scopes.Keys)
                ? true
                : _selected.Count == 0
                    ? false
                    : null;
        set
        {
            if (value is true)
            {
                _selected.UnionWith(_auth.Scopes.Keys);
            }
            else if (value is false)
            {
                _selected.Clear();
            }
        }
    }

    /// <summary>Gets or sets the package name.</summary>
    [Parameter]
    [SupplyParameterFromQuery(Name = "store")]
    public string StoreName { get; set; } = "";

    /// <summary>Gets or sets the authorization key.</summary>
    [Parameter]
    [SupplyParameterFromQuery(Name = "key")]
    public string Key { get; set; } = string.Empty;

    public string ErrorMessage { get; set; } = string.Empty;

    /// <summary>The authorization information.</summary>
    private AuthorizationInfo _auth = null!;

    private void HandleRowFocus(FluentDataGridRow<ImagingStudyInfo> row)
    {
        // _ = JsLogAsync($"Focused row item id: {row.Item?.Id}");

        if (row?.Item != null)
        {
            if (_selected.Contains(row.Item.StudyId))
            {
                _selected.Remove(row.Item.StudyId);
            }
            else
            {
                _selected.Add(row.Item.StudyId);
            }
        }

        StateHasChanged();
    }

    private void UpdateScopeInfo()
    {
        List<ImagingStudyInfo> scopeInfo = new();

        foreach (string study in _auth.EhrLaunch.matchingImagingStudies )
        {
            scopeInfo.Add(new()
            {
                StudyId = study,
                StudyDescription = "Study description."
            });
        }

        _items = scopeInfo.AsQueryable();
    }

    private bool ParseResourceScope(string scope, out string context, out string resourceType, out List<string> ops, out List<string> filters)
    {
        resourceType = string.Empty;
        context = string.Empty;
        ops = new();
        filters = new();

        if (string.IsNullOrEmpty(scope))
        {
            return false;
        }

        string contextRemoved;

        if (scope.StartsWith("patient/", StringComparison.Ordinal))
        {
            context = "Patient";
            contextRemoved = scope.Substring(8);
        }
        else if (scope.StartsWith("user/", StringComparison.Ordinal))
        {
            context = "User";
            contextRemoved = scope.Substring(5);
        }
        else
        {
            return false;
        }

        int opDelimiterLoc = contextRemoved.IndexOf('.');
        string opLiterals = opDelimiterLoc > 0 ? contextRemoved.Substring(opDelimiterLoc + 1) : string.Empty;
        resourceType = opDelimiterLoc > 0 ? contextRemoved.Substring(0, opDelimiterLoc) : contextRemoved;

        if (resourceType == "*")
        {
            resourceType = "ALL";
        }

        int filterDelimiterLoc = opLiterals.IndexOf('?');
        string filterLiterals = filterDelimiterLoc > 0 ? opLiterals.Substring(filterDelimiterLoc + 1) : string.Empty;
        opLiterals = filterDelimiterLoc > 0 ? opLiterals.Substring(0, filterDelimiterLoc) : opLiterals;

        if (!string.IsNullOrEmpty(filterLiterals))
        {
            filters.AddRange(filterLiterals.Split('&'));
        }

        if (opLiterals == "read")
        {
            ops.Add("Read");
            ops.Add("Search");
        }
        else if (opLiterals == "write")
        {
            ops.Add("Create");
            ops.Add("Update");
            ops.Add("Delete");
        }
        else if (opLiterals == "*")
        {
            ops.Add("Create");
            ops.Add("Read");
            ops.Add("Update");
            ops.Add("Delete");
            ops.Add("Search");
        }
        else
        {
            if (opLiterals.Contains("c", StringComparison.Ordinal))
            {
                ops.Add("Create");
            }

            if (opLiterals.Contains("r", StringComparison.Ordinal))
            {
                ops.Add("Read");
            }

            if (opLiterals.Contains("u", StringComparison.Ordinal))
            {
                ops.Add("Update");
            }

            if (opLiterals.Contains("d", StringComparison.Ordinal))
            {
                ops.Add("Delete");
            }

            if (opLiterals.Contains("s", StringComparison.Ordinal))
            {
                ops.Add("Search");
            }
        }

        return true;
    }

    /// <summary>Executes the initialized asynchronous action.</summary>
    /// <returns>An asynchronous result.</returns>
    protected override void OnInitialized()
    {
        base.OnInitialized();

        if (AuthorizationManager.TryGetAuthorization(StoreName, Key, out _auth))
        {
            UpdateScopeInfo();
            _selected.Clear();
            AllImagingStudieselected = true;
        }

        NavTracker?.NotifyNav(_navPages);
    }

    private void DenyAuth()
    {
        if (AuthorizationManager.TryGetClientRedirect(StoreName, Key, out string url, "denied", "authorization request was denied"))
        {
            NavigationManager.NavigateTo(url);
        }

        // TODO: show an error on the screen
    }

    private void ApproveAuth()
    {
        foreach (string scope in _auth.Scopes.Keys)
        {
            _auth.Scopes[scope] = _selected.Contains(scope);
        }

        _ = AuthorizationManager.TryUpdateAuth(StoreName, Key, _auth);

        if (!AuthorizationManager.TryGetClientRedirect(StoreName, Key, out string redirect))
        {
            ErrorMessage = "Failed to retrieve redirect URL for client.";
            return;
        }

        NavigationManager.NavigateTo(redirect);
    }

    /// <summary>Handles the location changed.</summary>
    /// <param name="sender">The sender.</param>
    /// <param name="e">     Location changed event information.</param>
    private void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        if (e.Location.ToLowerInvariant().Contains("/smart/auth?", StringComparison.Ordinal))
        {
            _ = AuthorizationManager.TryGetAuthorization(StoreName, Key, out _auth);

            NavTracker?.NotifyNav(_navPages);
        }
    }

    /// <summary>
    /// Performs application-defined tasks associated with freeing, releasing, or resetting unmanaged
    /// resources.
    /// </summary>
    public void Dispose()
    {
        // if (_store != null)
        // {
        // }
    }
}
